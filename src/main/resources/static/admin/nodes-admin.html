<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fun AI Studio - Nodes 管理</title>
  <style>
    :root{
      color-scheme:light dark;
      --bg:#0b1220; --bd:rgba(255,255,255,.12); --bd2:rgba(255,255,255,.08);
      --txt:#e8eefc; --muted:rgba(232,238,252,.72);
      --pri:#60a5fa; --danger:#ff8a8a; --ok:#9bf6b0; --warn:#ffd37a;
      --mono:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
    }
    *{box-sizing:border-box}
    body{margin:0;padding:16px;background:var(--bg);color:var(--txt);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .title{font-size:16px;font-weight:900}
    .status{font-size:12px;color:var(--muted);max-width:100%;word-break:break-word}
    .card{background:rgba(255,255,255,.06);border:1px solid var(--bd);border-radius:14px;padding:12px;margin-top:12px}
    .grid{display:grid;grid-template-columns: 360px 1fr;gap:12px;align-items:start}
    @media (max-width: 1040px){ .grid{grid-template-columns:1fr} }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .row > *{min-width:120px}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input,button,select{
      border-radius:10px;border:1px solid var(--bd2);background:rgba(0,0,0,.22);color:var(--txt);
      padding:10px 10px;font-size:13px;outline:none
    }
    input,select{width:100%}
    input:focus,select:focus{border-color:rgba(96,165,250,.65);box-shadow:0 0 0 3px rgba(96,165,250,.15)}
    .btn{cursor:pointer;background:rgba(96,165,250,.18);border-color:rgba(96,165,250,.35)}
    .btn:hover{background:rgba(96,165,250,.26)}
    .btn.secondary{background:rgba(255,255,255,.06);border-color:var(--bd2)}
    .btn.secondary:hover{background:rgba(255,255,255,.10)}
    .btn.danger{background:rgba(255,138,138,.16);border-color:rgba(255,138,138,.35)}
    .btn.danger:hover{background:rgba(255,138,138,.22)}
    .btn.pill{
      border-radius:999px;
      padding:10px 14px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      text-decoration:none;
      white-space:nowrap;
    }
    .btn.pill .ico{font-family:var(--mono);opacity:.95}
    .pillTag{display:inline-block;padding:2px 8px;border:1px solid var(--bd2);border-radius:999px;font-size:12px;color:var(--muted)}
    .warn{color:var(--warn)}
    .small{font-size:12px;color:var(--muted);line-height:1.7}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{border-bottom:1px solid var(--bd2);padding:10px 8px;font-size:12px;text-align:left;vertical-align:top}
    th{color:var(--muted);font-weight:650}
    code{font-family:var(--mono);background:rgba(255,255,255,.08);padding:2px 6px;border-radius:8px}
    .ok{color:var(--ok)} .err{color:var(--danger)}
    .kpi{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .kpi .box{flex:1;min-width:180px;background:rgba(0,0,0,.18);border:1px solid var(--bd2);border-radius:12px;padding:10px}
    .kpi .box .k{font-size:12px;color:var(--muted)}
    .kpi .box .v{font-size:18px;font-weight:900;margin-top:4px}
  </style>
</head>
<body>
  <div class="top">
    <div>
      <div class="title" id="pageTitle">Nodes 管理</div>
      <div class="status" id="status"></div>
    </div>
    <div class="row" style="min-width:320px;max-width:780px;width:100%;justify-content:flex-end">
      <a class="btn pill secondary" id="btnBack" href="/admin/nodes.html"><span class="ico">←</span><span>返回入口</span></a>
      <button id="btnReload" class="btn">刷新列表</button>
      <button id="btnFillFromSel" class="btn secondary">填充选中行</button>
      <select id="modeSelect" style="max-width:220px">
        <option value="workspace">Workspace Node 管理</option>
        <option value="deploy">Deploy Node 管理</option>
      </select>
    </div>
  </div>

  <div class="grid">
    <div>
      <div class="card">
        <div class="pillTag">鉴权：IP 白名单 + Header Token</div>
        <label>Admin Token（Header: X-Admin-Token）</label>
        <input id="adminToken" placeholder="建议放 URL hash：#token=xxx（不会进 access log）" />
        <div class="small" style="margin-top:10px">
          提示：节点管理 API 不依赖 JWT；需要在后端配置 <code>funai.admin.allowed-ips</code> 与 <code>funai.admin.token</code>。
        </div>
      </div>
      <div class="card" id="featureBox">
        <h3 style="margin:0 0 10px 0;font-size:14px">功能区</h3>
        <div class="small" id="featureHint">-</div>
      </div>
    </div>
    <div class="card">
      <h3 style="margin:0;font-size:14px" id="listTitle">节点列表</h3>
      <div class="kpi" id="kpi">
        <div class="box"><div class="k">总用户数</div><div class="v" id="k_totalUsers">-</div></div>
        <div class="box"><div class="k">总落点数</div><div class="v" id="k_totalPlacements">-</div></div>
        <div class="box"><div class="k">节点数</div><div class="v" id="k_nodes">-</div></div>
      </div>
      <div class="small" id="listHint" style="margin-top:8px"></div>
      <table>
        <thead id="thead"></thead>
        <tbody id="tbody">
          <tr><td colspan="10" class="small">暂无数据，点击“刷新列表”。</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const state = { selected: null, rows: [], totalUsers: 0, totalPlacements: 0, mode: "workspace" };

    function setStatus(text, kind) {
      const el = $("status");
      el.textContent = text || "";
      el.className = "status " + (kind === "err" ? "err" : kind === "ok" ? "ok" : "");
    }

    function ensureToken() {
      const tok = ($("adminToken")?.value || "").trim();
      if (!tok) {
        setStatus("请先填写 Admin Token（Header: X-Admin-Token）", "err");
        return false;
      }
      return true;
    }

    function parseHashToken() {
      const h = new URLSearchParams((location.hash || "").replace(/^#/, ""));
      return (h.get("token") || "").trim();
    }

    function parseMode() {
      const q = new URLSearchParams(location.search || "");
      const m = (q.get("mode") || "workspace").trim();
      return (m === "deploy") ? "deploy" : "workspace";
    }

    function setMode(mode) {
      state.mode = mode;
      $("modeSelect").value = mode;
      renderThead();
      // 同步刷新当前表格占位行的列数（避免 mode 切换后 colspan 不一致）
      renderKpi();
      renderTable(state.rows);
      if (mode === "workspace") {
        document.title = "Fun AI Studio - Workspace Node 管理";
        $("pageTitle").textContent = "Workspace Node 管理";
        $("listTitle").textContent = "节点列表（Workspace）";
        $("listHint").textContent = "右侧默认展示节点列表与指标；点击行可选中，左侧可做新增/更新。";
        $("featureBox").innerHTML = `
          <h3 style="margin:0 0 10px 0;font-size:14px">功能区：新增/更新节点</h3>
          <label>id（更新时填；新增留空）</label>
          <input id="f_id" placeholder="例如 1" />
          <label>name</label>
          <input id="f_name" placeholder="ws-node-01" />
          <label>nginxBaseUrl（节点 Nginx，用于 /ws 路由）</label>
          <input id="f_nginx" placeholder="http://39.97.61.139" />
          <label>apiBaseUrl（workspace-node:7001，用于 /api/fun-ai/workspace/** 代理）</label>
          <input id="f_api" placeholder="http://172.21.138.87:7001" />
          <label>enabled（1/0）</label>
          <input id="f_enabled" value="0" />
          <label>weight（可选）</label>
          <input id="f_weight" value="100" />
          <div class="row" style="margin-top:10px">
            <button id="btnUpsert" class="btn">保存</button>
            <button id="btnClear" class="btn secondary">清空</button>
          </div>
          <div class="small" style="margin-top:10px">
            方案 A（只让新用户进新节点）：把新节点 enabled=1，保持老节点 baseUrl 不变即可。
          </div>
          <hr style="margin:14px 0;border:0;border-top:1px solid var(--bd2)"/>
          <h3 style="margin:0 0 10px 0;font-size:14px">功能区：Placements / 迁移 / Drain</h3>
          <div class="small" style="margin-top:2px">
            提示：心跳接口使用 <code>X-WS-Node-Token</code>，本页面不会调用；本页面仅使用 <code>X-Admin-Token</code> 操作 placements/reassign/drain。
          </div>
          <label>选中 NodeId</label>
          <input id="p_nodeId" placeholder="在右侧表格选中一行后自动填充" />
          <div class="row" style="margin-top:10px">
            <button id="btnPlacements" class="btn secondary">查看 Placements</button>
            <button id="btnDrain" class="btn danger">Drain 到目标节点</button>
          </div>
          <label style="margin-top:12px">Drain 目标 NodeId</label>
          <input id="p_targetNodeId" placeholder="例如 2" />
          <label>Drain limit（单次最多迁移）</label>
          <input id="p_drainLimit" value="100" />

          <label style="margin-top:12px">手工迁移：UserId</label>
          <input id="p_userId" placeholder="例如 10000021" />
          <label>手工迁移：目标 NodeId</label>
          <input id="p_userTargetNodeId" placeholder="例如 2" />
          <div class="row" style="margin-top:10px">
            <button id="btnReassign" class="btn">Reassign</button>
          </div>

          <div class="small" style="margin-top:10px">
            自动迁移开关在后端配置：<code>workspace-node.failover.auto-reassign.enabled</code>（默认关闭）。
          </div>

          <div class="card" style="margin-top:12px;padding:10px">
            <div class="small">Placements 结果：</div>
            <div id="placementsBox" class="small" style="margin-top:8px;max-height:260px;overflow:auto"></div>
          </div>
        `;
        $("btnUpsert").onclick = onUpsert;
        $("btnClear").onclick = onClear;
        $("btnPlacements").onclick = onPlacements;
        $("btnDrain").onclick = onDrain;
        $("btnReassign").onclick = onReassign;
      } else {
        document.title = "Fun AI Studio - Deploy Node 管理";
        $("pageTitle").textContent = "Deploy Node 管理";
        $("listTitle").textContent = "节点列表（Deploy）";
        $("listHint").innerHTML = '说明：该模块通过后端 <code>deploy-proxy</code> 转发到 Deploy 控制面 <code>/admin/runtime-nodes/**</code>；需在后端开启 <code>deploy-proxy.enabled=true</code> 并配置 <code>deploy-proxy.base-url</code>。';
        $("featureBox").innerHTML = `
          <h3 style="margin:0 0 10px 0;font-size:14px">在线状态：Deploy / Runner</h3>
          <div class="row" style="margin-top:6px">
            <button id="btnDeployStatus" class="btn secondary">刷新状态</button>
          </div>
          <div class="small" style="margin-top:10px">
            Deploy 健康检查：
            <div id="deployHealthBox" class="small" style="margin-top:8px;max-height:140px;overflow:auto"></div>
          </div>
          <div class="small" style="margin-top:10px">
            Runner 列表：
            <div id="deployRunnerBox" class="small" style="margin-top:8px;max-height:200px;overflow:auto"></div>
          </div>
          <hr style="margin:14px 0;border:0;border-top:1px solid var(--bd2)"/>
          <h3 style="margin:0 0 10px 0;font-size:14px">功能区：新增/更新 Deploy runtime 节点</h3>
          <label>name（必填，唯一）</label>
          <input id="d_name" placeholder="deploy-node-01" />
          <label>agentBaseUrl（运行时 Agent / 管理面）</label>
          <input id="d_agent" placeholder="http://127.0.0.1:18080" />
          <label>gatewayBaseUrl（对外网关）</label>
          <input id="d_gateway" placeholder="http://127.0.0.1:8080" />
          <label>enabled（true/false）</label>
          <input id="d_enabled" value="true" />
          <label>weight（可选）</label>
          <input id="d_weight" value="100" />
          <div class="row" style="margin-top:10px">
            <button id="btnDeployUpsert" class="btn">保存</button>
            <button id="btnDeployClear" class="btn secondary">清空</button>
          </div>
          <hr style="margin:14px 0;border:0;border-top:1px solid var(--bd2)"/>
          <h3 style="margin:0 0 10px 0;font-size:14px">功能区：Placements / 迁移 / Drain</h3>
          <label>选中 NodeId</label>
          <input id="d_nodeId" placeholder="在右侧表格选中一行后自动填充" />
          <div class="row" style="margin-top:10px">
            <button id="btnDeployPlacements" class="btn secondary">查看 Placements</button>
            <button id="btnDeployDrain" class="btn danger">Drain 到目标节点</button>
          </div>
          <label style="margin-top:12px">Drain 目标 NodeId</label>
          <input id="d_targetNodeId" placeholder="例如 2" />
          <label>Drain limit（单次最多迁移）</label>
          <input id="d_drainLimit" value="200" />

          <label style="margin-top:12px">手工迁移：AppId</label>
          <input id="d_appId" placeholder="例如 10001" />
          <label>手工迁移：目标 NodeId</label>
          <input id="d_appTargetNodeId" placeholder="例如 2" />
          <div class="row" style="margin-top:10px">
            <button id="btnDeployReassign" class="btn">Reassign</button>
          </div>

          <div class="card" style="margin-top:12px;padding:10px">
            <div class="small">Placements 结果：</div>
            <div id="deployPlacementsBox" class="small" style="margin-top:8px;max-height:260px;overflow:auto"></div>
          </div>
        `;
        $("btnDeployStatus").onclick = onDeployStatus;
        $("btnDeployUpsert").onclick = onDeployUpsert;
        $("btnDeployClear").onclick = onDeployClear;
        $("btnDeployPlacements").onclick = onDeployPlacements;
        $("btnDeployDrain").onclick = onDeployDrain;
        $("btnDeployReassign").onclick = onDeployReassign;
      }
    }

    function adminHeaders() {
      const tok = ($("adminToken").value || "").trim();
      return { "Content-Type": "application/json", "X-Admin-Token": tok };
    }

    async function apiGet(path, params) {
      const qs = params ? ("?" + new URLSearchParams(params).toString()) : "";
      const r = await fetch(path + qs, { headers: adminHeaders() });
      const txt = await r.text();
      try { return JSON.parse(txt); } catch (e) { throw new Error("响应不是 JSON：" + txt.slice(0, 200)); }
    }

    async function apiPost(path, params, body) {
      const qs = params ? ("?" + new URLSearchParams(params).toString()) : "";
      const r = await fetch(path + qs, { method: "POST", headers: adminHeaders(), body: JSON.stringify(body || {}) });
      const txt = await r.text();
      try { return JSON.parse(txt); } catch (e) { throw new Error("响应不是 JSON：" + txt.slice(0, 200)); }
    }

    function renderKpi() {
      if (state.mode === "workspace") {
        $("k_totalUsers").textContent = String(state.totalUsers ?? 0);
        $("k_totalPlacements").textContent = String(state.totalPlacements ?? 0);
        $("k_nodes").textContent = String((state.rows || []).length);
        return;
      }
      // deploy：没有 totalUsers/totalPlacements 概念；只显示节点数
      $("k_totalUsers").textContent = "-";
      $("k_totalPlacements").textContent = "-";
      $("k_nodes").textContent = String((state.rows || []).length);
    }

    function escapeHtml(s) {
      return String(s || "").replace(/[&<>"']/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    function pct(n, d) {
      const nn = Number(n || 0);
      const dd = Number(d || 0);
      if (!dd) return "0%";
      return (Math.round((nn / dd) * 1000) / 10).toFixed(1) + "%";
    }

    function renderThead() {
      const th = $("thead");
      if (!th) return;
      if (state.mode === "deploy") {
        th.innerHTML = `
          <tr>
            <th>nodeId</th><th>name</th><th>enabled</th><th>健康</th><th>心跳</th><th>agentBaseUrl</th><th>gatewayBaseUrl</th><th>weight</th><th>操作</th>
          </tr>
        `;
      } else {
        th.innerHTML = `
          <tr>
            <th>id</th><th>name</th><th>enabled</th><th>健康</th><th>心跳</th><th>落盘用户数</th><th>占比</th><th>nginx（IP/URL）</th><th>api（IP/URL）</th><th>操作</th>
          </tr>
        `;
      }
    }

    function enabledBadge(mode, enabled) {
      if (mode === "deploy") {
        const ok = (enabled === true || enabled === "true" || enabled === 1 || enabled === "1");
        return ok ? '<span class="ok">true</span>' : '<span class="err">false</span>';
      }
      return (enabled === 1 ? '<span class="ok">1</span>' : '<span class="err">0</span>');
    }

    function healthBadge(health) {
      const h = (health || "UNKNOWN");
      return h === "HEALTHY" ? '<span class="ok">HEALTHY</span>'
           : h === "STALE" ? '<span class="warn">STALE</span>'
           : '<span class="small">UNKNOWN</span>';
    }

    function renderTable(rows) {
      const tb = $("tbody");
      tb.innerHTML = "";
      const colCount = (state.mode === "deploy") ? 9 : 10;
      if (!rows || rows.length === 0) {
        tb.innerHTML = `<tr><td colspan="${colCount}" class="small">（空）</td></tr>`;
        return;
      }
      rows.forEach((r) => {
        const tr = document.createElement("tr");
        tr.style.cursor = "pointer";
        tr.onclick = () => { state.selected = r; renderTable(state.rows); };
        const selKey = state.mode === "deploy" ? String(state.selected?.nodeId ?? "") : String(state.selected?.nodeId ?? "");
        const rowKey = String(r.nodeId ?? r.id ?? "");
        if (state.selected && selKey && selKey === rowKey) {
          tr.style.background = "rgba(96,165,250,.08)";
        }
        const hbMs = r.lastHeartbeatAtMs;
        const hbText = hbMs ? new Date(hbMs).toLocaleString() : "-";
        if (state.mode === "deploy") {
          tr.innerHTML = `
            <td>${r.nodeId ?? ""}</td>
            <td><code>${escapeHtml(r.name ?? "")}</code></td>
            <td>${enabledBadge("deploy", r.enabled)}</td>
            <td>${healthBadge(r.health)}</td>
            <td><code>${escapeHtml(hbText)}</code></td>
            <td><code>${escapeHtml(r.agentBaseUrl ?? "")}</code></td>
            <td><code>${escapeHtml(r.gatewayBaseUrl ?? "")}</code></td>
            <td>${r.weight ?? "-"}</td>
            <td>
              <button class="btn secondary" data-act="enable">启用</button>
              <button class="btn danger" data-act="disable" style="margin-left:6px">禁用</button>
            </td>
          `;
        } else {
          const share = pct(r.assignedUsers, state.totalPlacements || rows.reduce((a,x)=>a+(x.assignedUsers||0),0));
          tr.innerHTML = `
            <td>${r.nodeId ?? ""}</td>
            <td><code>${escapeHtml(r.name ?? "")}</code></td>
            <td>${enabledBadge("workspace", r.enabled)}</td>
            <td>${healthBadge(r.health)}</td>
            <td><code>${escapeHtml(hbText)}</code></td>
            <td>${r.assignedUsers ?? 0}</td>
            <td>${share}</td>
            <td><code>${escapeHtml(r.nginxBaseUrl ?? "")}</code></td>
            <td><code>${escapeHtml(r.apiBaseUrl ?? "")}</code></td>
            <td>
              <button class="btn secondary" data-act="enable">启用</button>
              <button class="btn danger" data-act="disable" style="margin-left:6px">禁用</button>
            </td>
          `;
        }
        tr.querySelectorAll("button").forEach((btn) => {
          btn.onclick = async (e) => {
            e.stopPropagation();
            const act = btn.getAttribute("data-act");
            try {
              if (!ensureToken()) return;
              if (state.mode === "deploy") {
                const enabled = act === "enable" ? 1 : 0;
                const name = (r.name || "").trim();
                if (!name) throw new Error("name 为空，无法 set-enabled");
                const res = await apiPost("/api/fun-ai/admin/deploy-nodes/set-enabled", { name, enabled }, {});
                if (res.code !== 200) throw new Error(res.message || "请求失败");
              } else {
                const enabled = act === "enable" ? 1 : 0;
                const res = await apiPost("/api/fun-ai/admin/workspace-nodes/set-enabled", { nodeId: r.nodeId, enabled });
                if (res.code !== 200) throw new Error(res.message || "请求失败");
              }
              await reload();
            } catch (err) {
              setStatus(String(err.message || err), "err");
            }
          };
        });
        tb.appendChild(tr);
      });
    }

    async function reload() {
      setStatus("加载中...", "");
      if (!ensureToken()) return;
      if (state.mode === "deploy") {
        const res = await apiGet("/api/fun-ai/admin/deploy-nodes/list");
        if (res.code !== 200) throw new Error(res.message || "请求失败");
        state.totalUsers = 0;
        state.totalPlacements = 0;
        state.rows = res.data || [];
        renderKpi();
        renderTable(state.rows);
        setStatus(`OK：deploy nodes=${state.rows.length}`, "ok");
        return;
      }

      const res = await apiGet("/api/fun-ai/admin/workspace-nodes/list");
      if (res.code !== 200) throw new Error(res.message || "请求失败");
      const data = res.data || {};
      state.totalUsers = data.totalUsers ?? 0;
      state.totalPlacements = data.totalPlacements ?? 0;
      state.rows = data.nodes || [];
      renderKpi();
      renderTable(state.rows);
      setStatus(`OK：nodes=${state.rows.length} totalUsers=${state.totalUsers} totalPlacements=${state.totalPlacements}`, "ok");
      try { localStorage.setItem("admin_ws_nodes_token", $("adminToken").value.trim()); } catch (e) {}
    }

    async function onUpsert() {
      try {
        if (!ensureToken()) return;
        const body = {
          id: (($("f_id")?.value || "").trim()) ? parseInt($("f_id").value.trim(), 10) : null,
          name: ($("f_name")?.value || "").trim(),
          nginxBaseUrl: ($("f_nginx")?.value || "").trim(),
          apiBaseUrl: ($("f_api")?.value || "").trim(),
          enabled: parseInt((($("f_enabled")?.value || "0").trim()), 10),
          weight: parseInt((($("f_weight")?.value || "100").trim()), 10),
        };
        if (!body.name) throw new Error("name 不能为空");
        if (!body.nginxBaseUrl) throw new Error("nginxBaseUrl 不能为空");
        if (!body.apiBaseUrl) throw new Error("apiBaseUrl 不能为空");
        const res = await apiPost("/api/fun-ai/admin/workspace-nodes/upsert", null, body);
        if (res.code !== 200) throw new Error(res.message || "请求失败");
        await reload();
        setStatus("保存成功", "ok");
      } catch (e) {
        setStatus(String(e.message || e), "err");
      }
    }

    function parseBoolLike(v) {
      const s = String(v ?? "").trim().toLowerCase();
      if (s === "true" || s === "1" || s === "yes" || s === "y") return true;
      if (s === "false" || s === "0" || s === "no" || s === "n") return false;
      return null;
    }

    async function onDeployUpsert() {
      try {
        if (!ensureToken()) return;
        const enabled = parseBoolLike(($("d_enabled")?.value || "").trim());
        if (enabled === null) throw new Error("enabled 只能填 true/false 或 1/0");
        const body = {
          name: ($("d_name")?.value || "").trim(),
          agentBaseUrl: ($("d_agent")?.value || "").trim(),
          gatewayBaseUrl: ($("d_gateway")?.value || "").trim(),
          enabled,
          weight: parseInt((($("d_weight")?.value || "100").trim()), 10),
        };
        if (!body.name) throw new Error("name 不能为空");
        const res = await apiPost("/api/fun-ai/admin/deploy-nodes/upsert", null, body);
        if (res.code !== 200) throw new Error(res.message || "请求失败");
        await reload();
        setStatus("保存成功", "ok");
      } catch (e) {
        setStatus(String(e.message || e), "err");
      }
    }

    function onDeployClear() {
      ["d_name","d_agent","d_gateway","d_enabled","d_weight","d_nodeId","d_targetNodeId","d_drainLimit","d_appId","d_appTargetNodeId"].forEach((k) => {
        const el = $(k);
        if (el) el.value = "";
      });
      if ($("d_enabled")) $("d_enabled").value = "true";
      if ($("d_weight")) $("d_weight").value = "100";
      if ($("d_drainLimit")) $("d_drainLimit").value = "200";
      setStatus("", "");
    }

    function onClear() {
      ["f_id","f_name","f_nginx","f_api","f_enabled","f_weight"].forEach((k) => {
        const el = $(k);
        if (el) el.value = "";
      });
      if ($("f_enabled")) $("f_enabled").value = "0";
      if ($("f_weight")) $("f_weight").value = "100";
      setStatus("", "");
    }

    $("btnReload").onclick = async () => { try { await reload(); } catch (e) { setStatus(String(e.message || e), "err"); } };
    $("btnFillFromSel").onclick = () => {
      const r = state.selected;
      if (!r) { setStatus("请先在表格中选中一行", "err"); return; }
      if (state.mode === "deploy") {
        if ($("d_name")) $("d_name").value = r.name ?? "";
        if ($("d_agent")) $("d_agent").value = r.agentBaseUrl ?? "";
        if ($("d_gateway")) $("d_gateway").value = r.gatewayBaseUrl ?? "";
        if ($("d_enabled")) $("d_enabled").value = String(r.enabled ?? false);
        if ($("d_weight")) $("d_weight").value = String(r.weight ?? 100);
        if ($("d_nodeId")) $("d_nodeId").value = String(r.nodeId ?? "");
      } else {
        if ($("f_id")) $("f_id").value = r.nodeId ?? "";
        if ($("f_name")) $("f_name").value = r.name ?? "";
        if ($("f_nginx")) $("f_nginx").value = r.nginxBaseUrl ?? "";
        if ($("f_api")) $("f_api").value = r.apiBaseUrl ?? "";
        if ($("f_enabled")) $("f_enabled").value = String(r.enabled ?? 0);
        if ($("f_weight")) $("f_weight").value = String(r.weight ?? 100);
        if ($("p_nodeId")) $("p_nodeId").value = String(r.nodeId ?? "");
      }
      setStatus("已填充选中行", "ok");
    };

    async function onPlacements() {
      try {
        if (!ensureToken()) return;
        const nodeId = ($("p_nodeId")?.value || "").trim();
        if (!nodeId) throw new Error("请先选择 nodeId");
        const res = await apiGet("/api/fun-ai/admin/workspace-nodes/placements", { nodeId, offset: 0, limit: 200 });
        if (res.code !== 200) throw new Error(res.message || "请求失败");
        const data = res.data || {};
        const items = data.items || [];
        const box = $("placementsBox");
        box.innerHTML = items.length
          ? items.map(it => `<div><code>userId=${escapeHtml(it.userId)}</code> <span class="pillTag">lastActiveAt=${escapeHtml(it.lastActiveAt||"")}</span></div>`).join("")
          : '<div class="small">（空）</div>';
        setStatus(`placements OK: nodeId=${nodeId} total=${data.total ?? items.length}`, "ok");
      } catch (e) {
        setStatus(String(e.message || e), "err");
      }
    }

    async function onDeployPlacements() {
      try {
        if (!ensureToken()) return;
        const nodeId = ($("d_nodeId")?.value || "").trim();
        if (!nodeId) throw new Error("请先选择 nodeId");
        const res = await apiGet("/api/fun-ai/admin/deploy-nodes/placements", { nodeId, offset: 0, limit: 200 });
        if (res.code !== 200) throw new Error(res.message || "请求失败");
        const data = res.data || {};
        const items = data.items || [];
        const box = $("deployPlacementsBox");
        box.innerHTML = items.length
          ? items.map(it => `<div><code>appId=${escapeHtml(it.appId)}</code> <span class="pillTag">lastActiveAt=${escapeHtml(it.lastActiveAt||"")}</span></div>`).join("")
          : '<div class="small">（空）</div>';
        setStatus(`deploy placements OK: nodeId=${nodeId} total=${data.total ?? items.length}`, "ok");
      } catch (e) {
        setStatus(String(e.message || e), "err");
      }
    }

    async function onDeployStatus() {
      try {
        if (!ensureToken()) return;
        const hb = $("deployHealthBox");
        const rb = $("deployRunnerBox");
        if (hb) hb.innerHTML = '<div class="small">加载中...</div>';
        if (rb) rb.innerHTML = '<div class="small">加载中...</div>';

        const resHealth = await apiGet("/api/fun-ai/admin/deploy-nodes/health");
        if (resHealth.code !== 200) throw new Error(resHealth.message || "deploy health 请求失败");
        const data = resHealth.data || {};
        const deploy = data.deploy || {};
        const ts = deploy.timestamp ? String(deploy.timestamp) : "-";
        const svc = deploy.service ? String(deploy.service) : "deploy";
        const proxyBaseUrl = data.proxyBaseUrl ? String(data.proxyBaseUrl) : "-";
        if (hb) {
          hb.innerHTML = `
            <div><span class="pillTag">proxyBaseUrl=${escapeHtml(proxyBaseUrl)}</span></div>
            <div style="margin-top:6px"><code>${escapeHtml(svc)}</code> <span class="pillTag">timestamp=${escapeHtml(ts)}</span></div>
          `;
        }

        const resRunners = await apiGet("/api/fun-ai/admin/deploy-nodes/runners/list");
        if (resRunners.code !== 200) throw new Error(resRunners.message || "runner list 请求失败");
        const runners = resRunners.data || [];
        if (rb) {
          rb.innerHTML = runners.length
            ? runners.map(r => {
                const at = r.lastSeenAtMs ? new Date(r.lastSeenAtMs).toLocaleString() : "-";
                const h = r.health || "UNKNOWN";
                const badge = h === "HEALTHY" ? '<span class="ok">HEALTHY</span>'
                            : h === "STALE" ? '<span class="warn">STALE</span>'
                            : '<span class="small">UNKNOWN</span>';
                return `<div>${badge} <code>${escapeHtml(r.runnerId||"")}</code> <span class="pillTag">lastSeen=${escapeHtml(at)}</span></div>`;
              }).join("")
            : '<div class="small">（空）</div>';
        }
        setStatus("状态刷新成功", "ok");
      } catch (e) {
        setStatus(String(e.message || e), "err");
      }
    }

    async function onReassign() {
      try {
        if (!ensureToken()) return;
        const userId = ($("p_userId")?.value || "").trim();
        const targetNodeId = ($("p_userTargetNodeId")?.value || "").trim();
        if (!userId) throw new Error("userId 不能为空");
        if (!targetNodeId) throw new Error("targetNodeId 不能为空");
        const body = { userId: parseInt(userId, 10), targetNodeId: parseInt(targetNodeId, 10) };
        const res = await apiPost("/api/fun-ai/admin/workspace-nodes/reassign", null, body);
        if (res.code !== 200) throw new Error(res.message || "请求失败");
        await reload();
        setStatus(`reassign OK: userId=${userId} -> nodeId=${targetNodeId}`, "ok");
      } catch (e) {
        setStatus(String(e.message || e), "err");
      }
    }

    async function onDeployReassign() {
      try {
        if (!ensureToken()) return;
        const appId = ($("d_appId")?.value || "").trim();
        const targetNodeId = ($("d_appTargetNodeId")?.value || "").trim();
        if (!appId) throw new Error("appId 不能为空");
        if (!targetNodeId) throw new Error("targetNodeId 不能为空");
        const body = { appId: parseInt(appId, 10), targetNodeId: parseInt(targetNodeId, 10) };
        const res = await apiPost("/api/fun-ai/admin/deploy-nodes/reassign", null, body);
        if (res.code !== 200) throw new Error(res.message || "请求失败");
        await reload();
        setStatus(`deploy reassign OK: appId=${appId} -> nodeId=${targetNodeId}`, "ok");
      } catch (e) {
        setStatus(String(e.message || e), "err");
      }
    }

    async function onDrain() {
      try {
        if (!ensureToken()) return;
        const sourceNodeId = ($("p_nodeId")?.value || "").trim();
        const targetNodeId = ($("p_targetNodeId")?.value || "").trim();
        const limit = parseInt((($("p_drainLimit")?.value || "100").trim()), 10);
        if (!sourceNodeId) throw new Error("请先选择 source nodeId");
        if (!targetNodeId) throw new Error("targetNodeId 不能为空");
        if (String(sourceNodeId) === String(targetNodeId)) throw new Error("source/target 不能相同");
        const body = { sourceNodeId: parseInt(sourceNodeId, 10), targetNodeId: parseInt(targetNodeId, 10), limit: isFinite(limit) ? limit : 100 };
        const res = await apiPost("/api/fun-ai/admin/workspace-nodes/drain", null, body);
        if (res.code !== 200) throw new Error(res.message || "请求失败");
        await reload();
        setStatus(`drain OK: moved=${res.data?.moved ?? "?"} ${sourceNodeId} -> ${targetNodeId}`, "ok");
      } catch (e) {
        setStatus(String(e.message || e), "err");
      }
    }

    async function onDeployDrain() {
      try {
        if (!ensureToken()) return;
        const sourceNodeId = ($("d_nodeId")?.value || "").trim();
        const targetNodeId = ($("d_targetNodeId")?.value || "").trim();
        const limit = parseInt((($("d_drainLimit")?.value || "200").trim()), 10);
        if (!sourceNodeId) throw new Error("请先选择 source nodeId");
        if (!targetNodeId) throw new Error("targetNodeId 不能为空");
        if (String(sourceNodeId) === String(targetNodeId)) throw new Error("source/target 不能相同");
        const body = { sourceNodeId: parseInt(sourceNodeId, 10), targetNodeId: parseInt(targetNodeId, 10), limit: isFinite(limit) ? limit : 200 };
        const res = await apiPost("/api/fun-ai/admin/deploy-nodes/drain", null, body);
        if (res.code !== 200) throw new Error(res.message || "请求失败");
        await reload();
        setStatus(`deploy drain OK: moved=${res.data?.moved ?? "?"} ${sourceNodeId} -> ${targetNodeId}`, "ok");
      } catch (e) {
        setStatus(String(e.message || e), "err");
      }
    }

    $("modeSelect").onchange = () => {
      const m = $("modeSelect").value;
      const q = new URLSearchParams(location.search || "");
      q.set("mode", m);
      history.replaceState(null, "", location.pathname + "?" + q.toString() + (location.hash || ""));
      setMode(m);
      reload().catch((e) => setStatus(String(e.message || e), "err"));
    };

    // init
    try {
      const fromHash = parseHashToken();
      const fromStore = (localStorage.getItem("admin_ws_nodes_token") || "").trim();
      $("adminToken").value = fromHash || fromStore || "";
    } catch (e) {}

    const initMode = parseMode();
    setMode(initMode);
    setStatus("提示：可先填 token，再刷新列表。", "");
  </script>
</body>
</html>


