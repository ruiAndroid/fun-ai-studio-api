<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fun Ai Studio Mongo Explorer</title>
  <style>
    :root{
      color-scheme:light dark;
      --bg:#0b1220;
      --card:#121826;
      --card2:#0f1522;
      --bd:rgba(255,255,255,.12);
      --bd2:rgba(255,255,255,.08);
      --txt:#e8eefc;
      --muted:rgba(232,238,252,.78);
      --muted2:rgba(232,238,252,.62);
      --pri:#60a5fa;
      --pri2:#1d4ed8;
      --danger:#ff8a8a;
      --ok:#9bf6b0;
      --mono:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
    }
    *{box-sizing:border-box}
    body{font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial; margin:0; padding:16px; background:var(--bg); color:var(--txt)}
    a{color:var(--pri)}
    code{background:rgba(255,255,255,.08); padding:2px 6px; border-radius:8px}

    .card{background:rgba(255,255,255,.06); border:1px solid var(--bd); border-radius:14px; padding:12px}
    .card h3{margin:0 0 10px 0; font-size:14px; letter-spacing:.2px}

    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px}
    input,textarea,select,button{
      width:100%;
      border-radius:10px;
      border:1px solid var(--bd2);
      background:rgba(0,0,0,.20);
      color:var(--txt);
      padding:10px 10px;
      font-size:13px;
      outline:none;
    }
    textarea{min-height:98px; font-family:var(--mono)}
    input:focus,textarea:focus,select:focus{border-color:rgba(96,165,250,.65); box-shadow:0 0 0 3px rgba(96,165,250,.15)}

    .btn{cursor:pointer; background:rgba(96,165,250,.18); border-color:rgba(96,165,250,.35)}
    .btn:hover{background:rgba(96,165,250,.26)}
    .btn.secondary{background:rgba(255,255,255,.06); border-color:var(--bd2)}
    .btn.secondary:hover{background:rgba(255,255,255,.10)}
    .btn:disabled{opacity:.55; cursor:not-allowed}
    .btn-row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .btn-row > button{flex:1; min-width:120px}

    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      margin-bottom:12px;
    }
    .brand{display:flex; align-items:center; gap:10px; min-width:0}
    .title{font-size:16px; font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .pill{font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid var(--bd2); background:rgba(255,255,255,.06); color:var(--muted)}
    .statusline{font-size:12px; color:var(--muted2); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:680px}

    .grid{display:grid; grid-template-columns: 360px 1fr; gap:12px; align-items:start}
    @media (max-width: 1040px){ .grid{grid-template-columns:1fr} .statusline{max-width:unset} }

    .cols{max-height:420px; overflow:auto}
    .col-item{
      padding:9px 10px; border-radius:10px;
      border:1px solid var(--bd2);
      background:rgba(0,0,0,.20);
      margin-bottom:8px; cursor:pointer;
      color:var(--muted);
    }
    .col-item:hover{border-color:rgba(96,165,250,.35); color:var(--txt)}
    .col-item.active{border-color:rgba(96,165,250,.75); color:var(--txt)}

    pre{
      white-space:pre-wrap; word-break:break-word;
      background:rgba(0,0,0,.24);
      border:1px solid var(--bd2);
      border-radius:14px;
      padding:12px;
      overflow:auto;
      max-height:520px;
      font-family:var(--mono);
      line-height:1.55;
    }
    .small{font-size:12px; color:var(--muted2)}
    .err{color:var(--danger)}
    .ok{color:var(--ok)}
    .kv{display:grid; grid-template-columns: 1fr 1fr; gap:10px}

    .modal-backdrop{
      display:none;
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      z-index:999;
      padding:24px;
    }
    .modal{
      width:min(860px,100%);
      margin:6vh auto 0;
      background:rgba(18,24,38,.96);
      border:1px solid var(--bd);
      border-radius:16px;
      padding:14px;
      box-shadow:0 20px 80px rgba(0,0,0,.55);
    }
    .modal h3{margin:0 0 8px 0}
    .modal .content{color:var(--muted); line-height:1.75}
    .modal .content ul{margin:8px 0 0 18px}
    .modal .content li{margin:4px 0}
    .modal .close-row{display:flex; justify-content:flex-end; margin-top:10px}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">
      <div class="title">Fun Ai Studio Mongo Explorer</div>
      <div class="pill">可写</div>
    </div>
    <div class="btn-row" style="justify-content:flex-end">
      <button id="btnHelp" class="btn secondary" style="max-width:140px">使用说明</button>
    </div>
  </div>
  <div id="status" class="statusline"></div>

  <div class="grid" style="margin-top:12px">
    <div>
      <div class="card">
        <h3>连接参数</h3>
        <div class="kv">
          <div>
            <label>userId</label>
            <input id="userId" placeholder="例如 1001" />
          </div>
          <div>
            <label>appId</label>
            <select id="appId"></select>
          </div>
        </div>
        <label>Authorization</label>
        <input id="token" placeholder="Bearer eyJ..." />
        <div class="btn-row" style="margin-top:10px">
          <button id="btnAuto" class="btn secondary">自动填充（当前登录）</button>
          <button id="btnLoadCols" class="btn">加载集合</button>
          <button id="btnClear" class="btn secondary">清空</button>
        </div>
        <div class="small" style="margin-top:10px">
          小贴士：token 推荐放在 URL hash（不进 access log），例如 <code>#token=Bearer%20eyJ...</code>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>Collections</h3>
        <div id="cols" class="cols small">请先“加载集合”</div>
      </div>
    </div>

    <div class="card">
      <h3>查询（find）</h3>
      <div class="kv">
        <div>
          <label>collection</label>
          <input id="collection" placeholder="例如 users" />
        </div>
        <div class="kv" style="grid-template-columns:1fr 1fr">
          <div>
            <label>limit</label>
            <input id="limit" value="50" />
          </div>
          <div>
            <label>skip</label>
            <input id="skip" value="0" />
          </div>
        </div>
      </div>
      <div class="kv">
        <div>
          <label>filter (JSON)</label>
          <textarea id="filter">{}</textarea>
        </div>
        <div>
          <label>sort (JSON，可空)</label>
          <textarea id="sort"></textarea>
        </div>
      </div>
      <label>projection (JSON，可空)</label>
      <textarea id="projection"></textarea>
      <div class="btn-row" style="margin-top:10px">
        <button id="btnFind" class="btn">查询</button>
        <button id="btnPretty" class="btn secondary">格式化 JSON</button>
      </div>
      <div class="small" style="margin-top:8px">
        提示：返回过大可能被后端截断导致解析失败，请降低 limit 或使用 projection。
      </div>
      <h3 style="margin-top:14px">结果</h3>
      <div class="small" style="margin:6px 0 8px">支持行级操作：编辑/删除（按 <code>_id</code>）。</div>
      <div id="tableBox" class="small" style="overflow:auto; border:1px solid var(--bd2); border-radius:14px; background:rgba(0,0,0,.16)"></div>
      <pre id="out" style="margin-top:10px">暂无</pre>
    </div>
  </div>

  <div class="grid" style="margin-top:12px">
    <div class="card">
      <h3>写入</h3>
      <label>新建集合（collection）</label>
      <div class="kv" style="grid-template-columns: 1fr 160px">
        <input id="newCollection" placeholder="例如 users" />
        <button id="btnCreateCol" class="btn">创建集合</button>
      </div>

      <label style="margin-top:12px">插入单条（insertOne）doc (JSON)</label>
      <textarea id="insertDoc">{}</textarea>
      <div class="btn-row" style="margin-top:10px">
        <button id="btnInsertOne" class="btn">插入到当前 collection</button>
        <button id="btnInsertPretty" class="btn secondary">格式化 doc</button>
      </div>
      <div class="small" style="margin-top:8px">
        提示：Mongo 可以不用显式“建表”，但这里仍提供 createCollection 以便更直观。
      </div>
    </div>

    <div class="card">
      <h3>高级：语句执行（安全 JSON 模式）</h3>
      <div class="small">不是任意 JS，也不是标准 SQL；请用 JSON 描述 op，后端按固定模板执行。</div>
      <label>op JSON</label>
      <textarea id="opJson">{
  "op": "find",
  "collection": "",
  "filter": "{}",
  "limit": 20,
  "skip": 0
}</textarea>
      <div class="btn-row" style="margin-top:10px">
        <button id="btnOpExec" class="btn">执行</button>
        <button id="btnOpPretty" class="btn secondary">格式化</button>
      </div>
    </div>
  </div>

  <div id="helpBackdrop" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <h3>使用说明</h3>
      <div class="content small">
        <div>本页面提供 Mongo 基础管理（查询 + 写入），接口仍需要 JWT。</div>
        <ul>
          <li>推荐把 token 放在 URL hash：<code>#token=Bearer%20&lt;JWT&gt;</code>（不会出现在 queryString / access log）</li>
          <li>也支持注入 <code>?userId=...</code>、<code>?appId=...</code></li>
          <li>点击「自动填充」会尝试从同域登录态读取 token，并拉取 app 列表</li>
          <li>查询结果过大时，请降低 <code>limit</code> 或使用 <code>projection</code></li>
          <li>行级编辑/删除依赖文档包含 <code>_id</code></li>
          <li>高级“语句执行”是安全 JSON 模式（op + 字段），不支持任意 JS</li>
        </ul>
      </div>
      <div class="close-row">
        <button id="btnHelpClose" class="btn secondary" style="max-width:140px">关闭</button>
      </div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const state = { activeCol: null };

    function parseParamsFromUrl() {
      const q = new URLSearchParams(location.search || "");
      const h = new URLSearchParams((location.hash || "").replace(/^#/, ""));
      // token 建议放 hash（不会上送服务器）
      return {
        userId: q.get("userId") || h.get("userId"),
        appId: q.get("appId") || h.get("appId"),
        token: h.get("token") || q.get("token") || h.get("auth") || q.get("auth"),
      };
    }

    function setStatus(text, kind) {
      const el = $("status");
      el.textContent = text || "";
      el.className = "statusline " + (kind === "err" ? "err" : kind === "ok" ? "ok" : "");
    }

    function guessTokenFromStorage() {
      const keys = [
        "token", "access_token", "accessToken", "jwt", "jwtToken",
        "Authorization", "auth", "authToken", "funai_token"
      ];
      for (const k of keys) {
        const v1 = (localStorage.getItem(k) || "").trim();
        if (v1) return v1;
        const v2 = (sessionStorage.getItem(k) || "").trim();
        if (v2) return v2;
      }
      return "";
    }

    function authHeaders() {
      const token = ($("token").value || "").trim();
      const h = { "Content-Type": "application/json" };
      if (token) h["Authorization"] = token.startsWith("Bearer ") ? token : ("Bearer " + token);
      return h;
    }

    function baseParams() {
      const userId = ($("userId").value || "").trim();
      const appId = ($("appId").value || "").trim();
      if (!userId || !appId) throw new Error("请先填写 userId/appId");
      return { userId, appId };
    }

    async function apiGetRaw(path, params) {
      const qs = params ? ("?" + new URLSearchParams(params).toString()) : "";
      const r = await fetch(path + qs, { headers: authHeaders() });
      return await r.json();
    }

    async function apiGet(path, params) {
      const qs = new URLSearchParams(params).toString();
      const r = await fetch(path + "?" + qs, { headers: authHeaders() });
      return await r.json();
    }

    async function apiPost(path, params, body) {
      const qs = new URLSearchParams(params).toString();
      const r = await fetch(path + "?" + qs, { method: "POST", headers: authHeaders(), body: JSON.stringify(body || {}) });
      return await r.json();
    }

    function extractId(doc) {
      if (!doc || typeof doc !== "object") return null;
      const v = doc._id;
      if (v == null) return null;
      if (typeof v === "string" || typeof v === "number") return String(v);
      if (typeof v === "object" && v.$oid) return String(v.$oid);
      return String(v);
    }

    function escHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function renderTable(items) {
      const box = $("tableBox");
      if (!items || items.length === 0) {
        box.innerHTML = "<div style='padding:10px;color:rgba(232,238,252,.62)'>（无数据）</div>";
        return;
      }
      // 展示前若干列：_id + json 摘要 + 操作
      const rows = items.map((it, idx) => {
        const id = extractId(it);
        const summary = escHtml(JSON.stringify(it).slice(0, 220));
        return `
          <tr>
            <td style="padding:8px;border-top:1px solid rgba(255,255,255,.08);font-family:var(--mono)">${escHtml(id || "")}</td>
            <td style="padding:8px;border-top:1px solid rgba(255,255,255,.08);color:rgba(232,238,252,.78)">${summary}${summary.length>=220?"…":""}</td>
            <td style="padding:8px;border-top:1px solid rgba(255,255,255,.08);white-space:nowrap">
              <button class="btn secondary" data-act="edit" data-idx="${idx}" style="width:auto;padding:6px 10px;border-radius:10px">编辑</button>
              <button class="btn secondary" data-act="del" data-idx="${idx}" style="width:auto;padding:6px 10px;border-radius:10px;border-color:rgba(255,138,138,.35)">删除</button>
            </td>
          </tr>
        `;
      }).join("");

      box.innerHTML = `
        <table style="width:100%;border-collapse:collapse">
          <thead>
            <tr>
              <th style="text-align:left;padding:8px;color:rgba(232,238,252,.78);font-size:12px">_id</th>
              <th style="text-align:left;padding:8px;color:rgba(232,238,252,.78);font-size:12px">doc</th>
              <th style="text-align:left;padding:8px;color:rgba(232,238,252,.78);font-size:12px">操作</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;
    }

    function renderCols(cols) {
      const box = $("cols");
      box.innerHTML = "";
      if (!cols || cols.length === 0) {
        box.textContent = "（空）";
        return;
      }
      cols.forEach((c) => {
        const div = document.createElement("div");
        div.className = "col-item" + (state.activeCol === c ? " active" : "");
        div.textContent = c;
        div.onclick = () => {
          state.activeCol = c;
          $("collection").value = c;
          renderCols(cols);
        };
        box.appendChild(div);
      });
    }

    function prettyAll() {
      ["filter","sort","projection"].forEach((k) => {
        const el = $(k);
        const v = (el.value || "").trim();
        if (!v) return;
        try { el.value = JSON.stringify(JSON.parse(v), null, 2); } catch (e) {}
      });
    }

    function renderAppOptions(apps) {
      const sel = $("appId");
      sel.innerHTML = "";
      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = "请选择 app";
      sel.appendChild(opt0);
      (apps || []).forEach((a) => {
        const opt = document.createElement("option");
        opt.value = String(a.id || a.appId || "");
        const name = (a.appName || a.name || ("app-" + opt.value));
        opt.textContent = `${name} (${opt.value})`;
        sel.appendChild(opt);
      });
    }

    async function autoFill() {
      setStatus("自动填充中...", "");
      // 1) token
      if (!$("token").value.trim()) {
        const guessed = guessTokenFromStorage();
        if (guessed) $("token").value = guessed;
      }
      const tokenNow = $("token").value.trim();
      if (!tokenNow) {
        setStatus("未检测到登录 Token：请在同域的已登录页面打开本页，或手动粘贴 Bearer Token（也可放到 URL hash：#token=...）", "err");
        return;
      }
      // 2) me -> userId
      const me = await apiGetRaw("/api/fun-ai/user/me");
      if (me.code !== 200 || !me.data) {
        throw new Error(me.message || "获取当前用户失败（请确认 token 有效）");
      }
      if (me.data.id) $("userId").value = String(me.data.id);

      // 3) app list（需要 userId）
      const res = await apiGetRaw("/api/fun-ai/app/list", { userId: $("userId").value.trim() });
      if (res.code !== 200) throw new Error(res.message || "获取 app 列表失败");
      renderAppOptions(res.data || []);

      setStatus(`OK：userId=${$("userId").value.trim()}，请选择 appId`, "ok");
    }

    $("btnAuto").onclick = async () => {
      try {
        await autoFill();
      } catch (e) {
        setStatus(String(e.message || e), "err");
      }
    };

    $("btnLoadCols").onclick = async () => {
      setStatus("加载中...", "");
      try {
        const p = baseParams();
        const res = await apiGet("/api/fun-ai/workspace/mongo/collections", p);
        if (res.code !== 200) throw new Error(res.message || "请求失败");
        renderCols((res.data && res.data.collections) || []);
        setStatus("OK: db=" + (res.data && res.data.dbName), "ok");
      } catch (e) {
        setStatus(String(e.message || e), "err");
      }
    };

    $("btnFind").onclick = async () => {
      setStatus("查询中...", "");
      $("out").textContent = "查询中...";
      try {
        const p = baseParams();
        const body = {
          collection: ($("collection").value || "").trim(),
          filter: ($("filter").value || "").trim(),
          projection: ($("projection").value || "").trim(),
          sort: ($("sort").value || "").trim(),
          limit: parseInt(($("limit").value || "50").trim(), 10),
          skip: parseInt(($("skip").value || "0").trim(), 10),
        };
        const res = await apiPost("/api/fun-ai/workspace/mongo/find", p, body);
        if (res.code !== 200) throw new Error(res.message || "请求失败");
        $("out").textContent = JSON.stringify(res.data, null, 2);
        renderTable((res.data && res.data.items) || []);
        setStatus("OK: returned=" + (res.data && res.data.returned), "ok");
      } catch (e) {
        $("out").textContent = String(e.stack || e.message || e);
        renderTable([]);
        setStatus(String(e.message || e), "err");
      }
    };

    $("btnPretty").onclick = () => {
      prettyAll();
      setStatus("已格式化（能解析的 JSON）", "ok");
    };

    $("btnInsertPretty").onclick = () => {
      const v = ($("insertDoc").value || "").trim();
      if (!v) return;
      try { $("insertDoc").value = JSON.stringify(JSON.parse(v), null, 2); } catch (e) {}
    };

    $("btnCreateCol").onclick = async () => {
      setStatus("创建集合中...", "");
      try {
        const p = baseParams();
        const body = { collection: ($("newCollection").value || "").trim() };
        const res = await apiPost("/api/fun-ai/workspace/mongo/create-collection", p, body);
        if (res.code !== 200) throw new Error(res.message || "请求失败");
        setStatus("OK: created=" + (res.data && res.data.created) + (res.data && res.data.message ? (", msg=" + res.data.message) : ""), "ok");
        // 刷新列表
        $("btnLoadCols").click();
      } catch (e) {
        setStatus(String(e.message || e), "err");
      }
    };

    $("btnInsertOne").onclick = async () => {
      setStatus("插入中...", "");
      try {
        const p = baseParams();
        const col = ($("collection").value || "").trim();
        if (!col) throw new Error("请先选择/输入 collection");
        const doc = ($("insertDoc").value || "").trim();
        // 先本地校验 JSON（避免后端报错难看）
        JSON.parse(doc);
        const res = await apiPost("/api/fun-ai/workspace/mongo/insert-one", p, { collection: col, doc });
        if (res.code !== 200) throw new Error(res.message || "请求失败");
        setStatus("OK: insertedId=" + (res.data && res.data.insertedId), "ok");
        // 重新查询当前页
        $("btnFind").click();
      } catch (e) {
        setStatus(String(e.message || e), "err");
      }
    };

    $("btnOpPretty").onclick = () => {
      const v = ($("opJson").value || "").trim();
      if (!v) return;
      try { $("opJson").value = JSON.stringify(JSON.parse(v), null, 2); } catch (e) {}
    };

    $("btnOpExec").onclick = async () => {
      setStatus("执行中...", "");
      try {
        const p = baseParams();
        const txt = ($("opJson").value || "").trim();
        const obj = JSON.parse(txt);
        const res = await apiPost("/api/fun-ai/workspace/mongo/op", p, obj);
        if (res.code !== 200) throw new Error(res.message || "请求失败");
        $("out").textContent = JSON.stringify(res.data, null, 2);
        // 若返回 find 结构则也渲染表格
        const items = res.data && res.data.items;
        renderTable(Array.isArray(items) ? items : []);
        setStatus("OK", "ok");
      } catch (e) {
        setStatus(String(e.message || e), "err");
      }
    };

    $("btnClear").onclick = () => {
      $("cols").textContent = "请先“加载集合”";
      $("collection").value = "";
      $("filter").value = "{}";
      $("sort").value = "";
      $("projection").value = "";
      $("out").textContent = "暂无";
      renderTable([]);
      setStatus("", "");
      state.activeCol = null;
    };

    // UI: help modal
    function openHelp() { $("helpBackdrop").style.display = "block"; }
    function closeHelp() { $("helpBackdrop").style.display = "none"; }
    $("btnHelp").onclick = openHelp;
    $("btnHelpClose").onclick = closeHelp;
    $("helpBackdrop").addEventListener("click", (e) => {
      if (e.target && e.target.id === "helpBackdrop") closeHelp();
    });
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closeHelp();
    });

    // 初始化：URL 参数优先，其次 localStorage；token 若为空再尝试自动猜测。
    try {
      const fromUrl = parseParamsFromUrl();
      const saved = JSON.parse(localStorage.getItem("ws_mongo_explorer") || "{}");
      const uid = (fromUrl.userId || saved.userId || "").trim();
      const aid = (fromUrl.appId || saved.appId || "").trim();
      const tok = (fromUrl.token || saved.token || "").trim();
      if (uid) $("userId").value = uid;
      if (tok) $("token").value = tok;
      // appId select：先放一个“当前选择”，后续 autoFill 会拉 app 列表并覆盖 options
      renderAppOptions(aid ? [{ id: aid, appName: "当前选择" }] : []);
      if (aid) $("appId").value = aid;
      if (!$("token").value.trim()) {
        const guessed = guessTokenFromStorage();
        if (guessed) $("token").value = guessed;
      }

      // 若 URL 已明确注入三要素（userId/appId/token），则直接锁定输入并提示用户可直接「加载集合」
      const injectedAll = !!(fromUrl.userId && fromUrl.appId && fromUrl.token);
      if (injectedAll) {
        $("userId").disabled = true;
        $("appId").disabled = true;
        $("token").disabled = true;
        setStatus("已从 URL 注入 userId/appId/token，可直接点击「加载集合」。（建议 token 放在 #hash 中）", "ok");
      }
    } catch (e) {
      renderAppOptions([]);
    }
    ["userId","appId","token"].forEach((k) => {
      $(k).addEventListener("change", () => {
        try {
          localStorage.setItem("ws_mongo_explorer", JSON.stringify({
            userId: $("userId").value.trim(),
            appId: $("appId").value.trim(),
            token: $("token").value.trim(),
          }));
        } catch (e) {}
      });
    });

    // 行级操作：编辑/删除（简单 prompt 交互）
    $("tableBox").addEventListener("click", async (e) => {
      const btn = e.target && e.target.closest ? e.target.closest("button[data-act]") : null;
      if (!btn) return;
      const act = btn.getAttribute("data-act");
      const idx = parseInt(btn.getAttribute("data-idx"), 10);
      try {
        const data = JSON.parse($("out").textContent || "{}");
        const items = (data && data.items) || [];
        const doc = items[idx];
        if (!doc) throw new Error("未找到行数据");
        const id = extractId(doc);
        const col = ($("collection").value || "").trim();
        if (!col) throw new Error("collection 为空");
        if (!id) throw new Error("该文档缺少 _id，无法执行行级操作");

        const p = baseParams();
        if (act === "del") {
          const ok = confirm(`确认删除？\ncollection=${col}\n_id=${id}`);
          if (!ok) return;
          const res = await apiPost("/api/fun-ai/workspace/mongo/delete-by-id", p, { collection: col, id });
          if (res.code !== 200) throw new Error(res.message || "请求失败");
          setStatus("OK: deletedCount=" + (res.data && res.data.deletedCount), "ok");
          $("btnFind").click();
          return;
        }

        if (act === "edit") {
          // 以 $set 方式更新：默认把 doc 除 _id 外全部 set 回去（可在弹窗里改）
          const clone = JSON.parse(JSON.stringify(doc));
          delete clone._id;
          const txt = prompt("编辑并保存（将作为 {$set: ...} 提交；不要包含 _id）", JSON.stringify(clone, null, 2));
          if (txt == null) return;
          const setObj = JSON.parse(txt);
          const update = JSON.stringify({ $set: setObj });
          const res = await apiPost("/api/fun-ai/workspace/mongo/update-by-id", p, { collection: col, id, update, upsert: false });
          if (res.code !== 200) throw new Error(res.message || "请求失败");
          setStatus("OK: matched=" + (res.data && res.data.matchedCount) + ", modified=" + (res.data && res.data.modifiedCount), "ok");
          $("btnFind").click();
          return;
        }
      } catch (err) {
        setStatus(String(err.message || err), "err");
      }
    });
  </script>
</body>
</html>


