groups:
  # ------------------------------------------------------------
  # FunAI Studio - 标准告警规则（示例）
  #
  # 使用方式：
  # - 复制到 /data/funai/monitoring/prometheus/rules/alerts.yml
  # - promtool check rules ... 校验后重启/热加载 Prometheus
  #
  # 说明：
  # - 阈值请按你们机器规格与业务形态做二次校准
  # - 初期建议先把告警接到一个低噪声渠道（群机器人/邮件），观察 1~3 天后再收敛
  # ------------------------------------------------------------

  - name: funai_standard_host
    rules:
      - alert: NodeExporterDown
        expr: up{job="node"} == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "node_exporter 不可达: {{ $labels.instance }}"
          description: "Prometheus 无法抓取 node_exporter（持续 2 分钟）。检查网络/安全组/进程。"

      - alert: HostDiskSpaceLow
        expr: |
          (node_filesystem_avail_bytes{fstype!~"tmpfs|overlay|squashfs"} / node_filesystem_size_bytes{fstype!~"tmpfs|overlay|squashfs"}) < 0.10
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "磁盘可用空间不足(<10%): {{ $labels.instance }} {{ $labels.mountpoint }}"
          description: "磁盘可用空间持续低于 10% 超过 10 分钟。优先检查 /data/funai 下的大目录。"

      - alert: HostDiskWillFillSoon
        expr: |
          predict_linear(node_filesystem_avail_bytes{fstype!~"tmpfs|overlay|squashfs"}[6h], 24 * 3600) < 0
        for: 30m
        labels:
          severity: warning
        annotations:
          summary: "磁盘预计 24h 内打满: {{ $labels.instance }} {{ $labels.mountpoint }}"
          description: "按过去 6h 线性趋势预测，24h 内可用空间将耗尽。"

      - alert: HostMemoryAvailableLow
        expr: |
          (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes) < 0.05
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "内存可用不足(<5%): {{ $labels.instance }}"
          description: "可用内存持续低于 5% 超过 5 分钟。检查是否有容器/进程异常占用。"

      - alert: HostCpuBusyHigh
        expr: |
          avg by (instance) (rate(node_cpu_seconds_total{job="node",mode!="idle"}[5m])) > 0.90
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "CPU 持续繁忙(>90%): {{ $labels.instance }}"
          description: "CPU 非 idle 占比持续超过 90%（10 分钟）。请结合 top/pidstat/container 指标定位热点。"

      - alert: HostRebooted
        expr: changes(node_boot_time_seconds{job="node"}[5m]) > 0
        labels:
          severity: info
        annotations:
          summary: "主机发生重启: {{ $labels.instance }}"
          description: "node_boot_time_seconds 在 5 分钟窗口内发生变化，表示主机刚刚重启。"

  - name: funai_standard_systemd
    rules:
      # 依赖 node_exporter 开启 --collector.systemd
      - alert: FunAiSystemdServiceDown
        expr: |
          node_systemd_unit_state{state="active",name=~"fun-ai-studio-.*\\.service"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "fun-ai-studio systemd 服务不在 active: {{ $labels.instance }} {{ $labels.name }}"
          description: "node_exporter systemd collector 发现服务非 active。检查 systemctl status / journalctl。"

  - name: funai_standard_blackbox
    rules:
      - alert: HttpProbeFailed
        expr: probe_success{job="blackbox_http"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "HTTP 探活失败: {{ $labels.instance }}"
          description: "blackbox 探测失败（持续 1 分钟）。检查目标服务是否存活、网络/安全组是否变化。"

      - alert: HttpProbeSlow
        expr: probe_duration_seconds{job="blackbox_http"} > 2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "HTTP 探活耗时偏高(>2s): {{ $labels.instance }}"
          description: "blackbox 探测耗时持续偏高（5 分钟）。检查目标服务负载、上游依赖与网络。"

  - name: funai_standard_prometheus
    rules:
      - alert: PrometheusConfigReloadFailed
        expr: prometheus_config_last_reload_successful == 0
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Prometheus 配置重载失败: {{ $labels.instance }}"
          description: "Prometheus 最近一次配置重载失败。检查 prometheus 日志与配置文件。"

      - alert: AlertmanagerDown
        expr: up{job="alertmanager"} == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Alertmanager 不可达: {{ $labels.instance }}"
          description: "Prometheus 无法抓取 Alertmanager 或 Alertmanager 不可用。告警可能无法发送。"

