# API 服务器（小机）Nginx：workspace 双机拆分（示例，仅供复制）
#
# 目标：
# - /preview/* 与 WebSocket 终端握手路径转发到 Workspace 开发服务器（大机）Nginx（Workspace 开发服务器（大机）负责 auth_request + 反代到 hostPort）
# - /api/fun-ai/workspace/** 不在 Nginx 层直转发（因为需要 HMAC 签名），由 API 服务器（小机）Spring Boot 的 proxy filter 转发
#
# 注意：
# - 该文件是示例，实际请放到 API 服务器（小机）/etc/nginx/conf.d/*.conf 的对应 server 块内
# - BIG_IP 替换为 Workspace 开发服务器（大机）公网 IP，例如 39.97.61.139

# WebSocket Upgrade 需要的 map（若 http{} 已配置可忽略）
map $http_upgrade $connection_upgrade {
    default upgrade;
    '' close;
}

# -----------------------------
# 0) /doc 文档与静态资源（必须固定走 API 上游）
# -----------------------------
# 背景：很多 Nginx 配置会写类似 location ~* \.(js|css|png|ico)$ 的规则，
# 这类“正则 location”优先级高，可能把 /doc-mermaid.js /favicon.ico 错误路由到 workspace-dev（大机）导致 502。
# 解决：用精确匹配/前缀匹配把这些路径强制走 API（并且放在所有 regex location 之前）。
#
# 说明：把 API_UPSTREAM 替换为你本机后端地址，例如 http://127.0.0.1:8080
#
set $API_UPSTREAM http://127.0.0.1:8080;
#
# Agent Node（88）：/fun-agent/** 由 91 Nginx 统一转发
# - 重要：stream/SSE 场景需要 proxy_buffering off，否则前端可能收不到持续输出
# - CORS：因为访问方是 https://funar.funshion.com（与 studio.fun.tv 不同源），需要显式返回 ACAO
#   若你使用 cookie/credentials，请同时返回 Access-Control-Allow-Credentials=true，并且 ACAO 不能是 "*"
#
# 把 AGENT_UPSTREAM 替换为你 88 机器可达地址（内网优先）
set $AGENT_UPSTREAM http://172.21.138.88:80;

location = /doc-mermaid.js {
    proxy_pass $API_UPSTREAM;
}
location = /favicon.ico {
    proxy_pass $API_UPSTREAM;
}
location ^~ /doc/ {
    proxy_pass $API_UPSTREAM;
}

# -----------------------------
# 0.1) Agent 服务：/fun-agent/**
# -----------------------------
location ^~ /fun-agent/ {
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # SSE/stream：禁用缓冲，避免“攒一大段才吐给浏览器”
    proxy_buffering off;
    proxy_read_timeout 3600s;
    proxy_send_timeout 3600s;

    # CORS（按需收敛域名；需要 credentials 时必须回显具体 Origin）
    # 说明：如果你不方便改 http{}（例如不能加 map），可以用 set+if 仅在当前 location 内做 allowlist
    # - 线上前端：https://funar.funshion.com
    # - 调试地址：https://172.17.9.149（允许带端口；不放行 http://）
    set $cors_allow_origin "https://funar.funshion.com";
    if ($http_origin ~ "^https://172\.17\.9\.149(:\d+)?$") { set $cors_allow_origin $http_origin; }

    add_header Access-Control-Allow-Origin $cors_allow_origin always;
    add_header Access-Control-Allow-Credentials "true" always;
    add_header Access-Control-Allow-Methods "GET,POST,PUT,DELETE,OPTIONS" always;
    add_header Access-Control-Allow-Headers "Authorization,Content-Type,X-Requested-With" always;
    add_header Vary "Origin" always;

    # preflight
    if ($request_method = OPTIONS) {
        return 204;
    }

    proxy_pass $AGENT_UPSTREAM;
}

# 1) 预览入口：/preview/{appId}/...
location ^~ /preview/ {
    proxy_http_version 1.1;

    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_read_timeout 3600s;
    proxy_send_timeout 3600s;
    proxy_buffering off;

    proxy_pass http://BIG_IP;
}

# 1.1) Vite/HMR 根路径资源（强烈建议加上）
# 场景：很多项目（尤其是 Vite dev）在 HTML 中会引用绝对路径资源，例如：
# - /@vite/client
# - /src/main.tsx
# - /@react-refresh
# 这些请求不带 /preview/{appId} 前缀，但浏览器仍会向“公网入口（API 服务器（小机））”发起请求。
# 如果 API 服务器（小机）不转发，会落到本机后端/静态资源，常见表现：200 text/html -> 浏览器报 MIME 错误白屏。
location ^~ /@vite/ {
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 3600s;
    proxy_send_timeout 3600s;
    proxy_buffering off;
    proxy_pass http://BIG_IP;
}
location ^~ /src/ {
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 3600s;
    proxy_send_timeout 3600s;
    proxy_buffering off;
    proxy_pass http://BIG_IP;
}
location = /@react-refresh {
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 3600s;
    proxy_send_timeout 3600s;
    proxy_buffering off;
    proxy_pass http://BIG_IP;
}
location = /__vite_ping {
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 3600s;
    proxy_send_timeout 3600s;
    proxy_buffering off;
    proxy_pass http://BIG_IP;
}

