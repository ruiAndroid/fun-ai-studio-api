# 阿里云部署文档（Linux 3 单机版：Workspace + Nginx 仅开放 80/443）

本文档用于 **从 0 初始化一台新服务器** 并部署本项目（Spring Boot + Workspace 容器 + Nginx 反代），目标是后续扩容/新机部署时可以按本文直接复现。

> 约定：本文以 **阿里云 ECS / Alibaba Cloud Linux 3** 为例。  
> 本文所有 URL 都用 `http://47.118.27.59`（你的公网 IP）举例，后续接入域名/HTTPS 时替换即可。

---

## 1. 服务器初始化（基础）

### 1.1 登录与更新

```bash
dnf update -y
dnf upgrade-minimal --security -y
```

### 1.2 常用工具

```bash
dnf install -y git unzip zip curl wget vim jq lsof
```

---

## 2. 安装运行时依赖

### 2.1 JDK 17（运行 Spring Boot）

```bash
dnf install -y java-17-openjdk java-17-openjdk-devel
java -version
```

### 2.2 Maven（构建）

你可以直接用系统包：

```bash
dnf install -y maven
mvn -v
```

若项目对 Maven 版本有要求，推荐手动安装指定版本（略）。

### 2.3 MySQL（按你现有项目配置）

如果你使用本机 MySQL：

```bash
dnf install -y mysql mysql-server
systemctl enable --now mysqld
systemctl status mysqld --no-pager
```

创建库（示例）：

```bash
mysql -uroot -p
CREATE DATABASE db_funaistudio DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;
```

> 生产建议：账号权限收敛 + 仅内网访问 + 备份策略。

### 2.4 Nginx（对外入口，仅开 80/443）

```bash
dnf install -y nginx
systemctl enable --now nginx
nginx -v
```

### 2.5 Docker / Podman（Workspace 容器）

本项目的 workspace 功能依赖 `docker` CLI。你现场环境可能是 `podman-docker` 仿真层（会出现提示：`Emulate Docker CLI using podman...`），可以继续用，但建议统一口径。

检查：

```bash
docker version
docker ps
```

> 若无 docker：需要安装 docker 或 podman-docker（略；各公司镜像源不同）。

---

## 3. 目录规划（生产建议）

本文采用以下目录（与你现在实践保持一致）：

- **后端部署目录**：`/opt/fun-ai-studio/`
- **后端配置目录**：`/opt/fun-ai-studio/config/`
- **workspace 宿主机持久化目录**：`/data/funai/workspaces/{userId}/...`
- **mongo 宿主机持久化目录（可选）**：`/data/funai/database/{userId}/mongo/...`（强烈建议不要放在 workspace 下）

创建目录：

```bash
mkdir -p /opt/fun-ai-studio/config
mkdir -p /data/funai/workspaces
mkdir -p /data/funai/database
```

---

## 4. 获取代码与构建

### 4.1 拉取代码

```bash
cd /opt
git clone <你的仓库地址> fun-ai-studio-api
cd /opt/fun-ai-studio-api
```

### 4.2 构建 jar

```bash
mvn -DskipTests clean package
ls -al target/*.jar
```

将产物复制到运行目录：

```bash
cp -f target/*.jar /opt/fun-ai-studio/app.jar
```

---

## 5. Spring Boot 生产配置

### 5.1 生产配置文件位置

项目启动参数使用：

- `--spring.profiles.active=prod`
- `--spring.config.location=/opt/fun-ai-studio/config/`

因此生产配置文件放在：

- `/opt/fun-ai-studio/config/application-prod.properties`

### 5.2 生产配置示例（重点项）

> 下面仅列关键字段；数据库/AI Key 等按你实际填写。

```properties
# 端口（如仍用 8080）
server.port=8080

# workspace 基本
funai.workspace.enabled=true
funai.workspace.hostRoot=/data/funai/workspaces
funai.workspace.image=crpi-xxx.cn-hangzhou.personal.cr.aliyuncs.com/xxx/funai-node:24.xx
funai.workspace.containerPort=5173
funai.workspace.hostPortBase=20000
funai.workspace.hostPortScanSize=2000
funai.workspace.containerWorkdir=/workspace
funai.workspace.containerNamePrefix=ws-u-

# 预览 URL：只走 80/443（路径反代）
funai.workspace.previewBaseUrl=http://47.118.27.59
funai.workspace.previewPathPrefix=/ws

# nginx auth_request 共享密钥（务必替换为强随机）
funai.workspace.nginxAuthToken=<YOUR_STRONG_RANDOM_TOKEN>

# idle 回收（省钱模式）
funai.workspace.idleStopRunMinutes=10
funai.workspace.idleStopContainerMinutes=20

# STARTING 超时：run/status 中 pid 长时间仍为空则判定为 DEAD（避免前端无限转圈）
funai.workspace.runStartingTimeoutSeconds=300

# 容器内网络代理（可选；公司网络/镜像源拉取慢时启用）
funai.workspace.httpProxy=http://host.containers.internal:3128
funai.workspace.httpsProxy=http://host.containers.internal:3128
funai.workspace.noProxy=localhost,127.0.0.1

# ===== Workspace Mongo（可选）=====
# 一个用户容器仅一个 mongod；dbPath 为用户级固定目录（bind mount 持久化），每个项目用 dbName 隔离：
# dbName = {dbNamePrefix}{appId}（例如 app_2002）
funai.workspace.mongo.enabled=false
funai.workspace.mongo.hostRoot=/data/funai/database
funai.workspace.mongo.containerDbPath=/data/db
funai.workspace.mongo.containerLogDir=/var/log/mongodb
funai.workspace.mongo.bindIp=127.0.0.1
funai.workspace.mongo.port=27017
funai.workspace.mongo.dbNamePrefix=app_
funai.workspace.mongo.logFileName=mongod.log
```

生成强随机 token（示例）：

```bash
openssl rand -hex 32
```

---

## 6. 以 systemd 方式运行后端

创建 service 文件：

```bash
cat >/etc/systemd/system/fun-ai-studio.service <<'EOF'
[Unit]
Description=fun-ai-studio-api
After=network.target

[Service]
Type=simple
WorkingDirectory=/opt/fun-ai-studio
ExecStart=/usr/bin/java -jar /opt/fun-ai-studio/app.jar --spring.profiles.active=prod --spring.config.location=/opt/fun-ai-studio/config/
Restart=always
RestartSec=3
LimitNOFILE=65535

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable --now fun-ai-studio
systemctl status fun-ai-studio --no-pager -l
```

查看日志（推荐）：

```bash
journalctl -u fun-ai-studio -f
```

---

## 7. Nginx 配置（API + /ws 预览反代 + 友好 502）

目标：

- 外部只访问 `80/443`
- `/` 反代到后端 `127.0.0.1:8080`
- `/ws/{userId}/...` 反代到对应用户 workspace 的 `hostPort`
- 若容器/端口未启动，返回友好页面提示“已休眠”

### 7.1 `/etc/nginx/conf.d/fun-ai-studio.conf`（最终版）

将 `<TOKEN>` 替换为 `application-prod.properties` 中 `funai.workspace.nginxAuthToken` 的值。

```nginx
server {
    listen 80 default_server;
    listen [::]:80 default_server;
    server_name 47.118.27.59 127.0.0.1 _;

    client_max_body_size 200m;

    # ===== 友好错误页：容器未启动（反代端口不可达） =====
    location = /__ws_sleeping {
        default_type text/html;  # 避免浏览器下载
        return 200 '<!doctype html><html><head><meta charset="utf-8"><title>Workspace 已休眠</title>
<style>body{font-family:system-ui,Segoe UI,Arial;margin:40px;max-width:720px}code{background:#f6f8fa;padding:2px 6px;border-radius:6px}</style>
</head><body>
<h2>Workspace 已休眠</h2>
<p>当前用户容器/Dev Server 未运行（省钱模式下会自动回收）。</p>
<p>请回到控制台页面点击「启动/恢复」，或等待启动完成后刷新本页。</p>
<p>如果长时间无法恢复，请查看后端 <code>/api/fun-ai/workspace/run/status</code> 的 message 或 dev.log。</p>
</body></html>';
    }

    # ===== 1) /ws/{userId}/... 反代到 127.0.0.1:{hostPort}（保留原始 URI）=====
    location ~ ^/ws/(?<uid>\d+)(?<rest>/.*)?$ {
        # 子请求要用到 userId（注意：子请求会继承该变量）
        set $ws_uid $uid;

        # 固定 URI 的 auth_request（不能用变量 URI）
        auth_request /_ws_port;
        auth_request_set $ws_port $upstream_http_x_ws_port;

        # 如果端口没起来，反代会 502/504 → 友好页
        proxy_intercept_errors on;
        error_page 502 504 = /__ws_sleeping;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        proxy_buffering off;
        proxy_read_timeout 3600s;

        # 关键：保留原始 URI，配合 Vite --base /ws/{userId}/
        proxy_pass http://127.0.0.1:$ws_port$request_uri;
    }

    # ===== 2) auth_request 子请求：查询端口（内部）=====
    location = /_ws_port {
        internal;

        proxy_pass http://127.0.0.1:8080/api/fun-ai/workspace/internal/nginx/port?userId=$ws_uid;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";

        # 共享密钥（和后端 funai.workspace.nginxAuthToken 保持一致）
        proxy_set_header X-WS-Token "<TOKEN>";
    }

    # ===== 3.5) WebSocket：在线终端/实时通道 =====
    location ^~ /api/fun-ai/workspace/ws/ {
        proxy_pass http://127.0.0.1:8080;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
        proxy_buffering off;
    }

    # ===== 3) 你的站点/API：反代给 Spring Boot =====
    location / {
        proxy_pass http://127.0.0.1:8080;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

应用配置：

```bash
nginx -t && systemctl reload nginx
```

### 7.2 验证命令

```bash
curl -I http://127.0.0.1/
curl -I http://127.0.0.1/ws/10000021/
curl -I http://47.118.27.59/ws/10000021/
```

---

## 8. Workspace 业务逻辑（核心设计）

### 8.1 目标与核心约束

- **每个用户一个 workspace 容器**：容器名 `ws-u-{userId}`（可通过 `funai.workspace.containerNamePrefix` 调整前缀）
- **每个用户一个持久化根目录（宿主机）**：`{hostRoot}/{userId}/`
- **目录与运行态文件“宿主机/容器共享”**：整段 `{hostRoot}/{userId}` 会挂载到容器内 `containerWorkdir`（默认 `/workspace`）
  - 宿主机：`{hostRoot}/{userId}/apps/{appId}`  <->  容器内：`/workspace/apps/{appId}`
  - 宿主机：`{hostRoot}/{userId}/run/`  <->  容器内：`/workspace/run/`
- **同一用户同一时间仅允许运行一个 app（切换模式）**：当调用 `run/start` 启动新的 `appId` 时，如果已有其它 `appId` 处于 `RUNNING/STARTING`，会先 `stop` 再启动目标 app。

### 8.2 元数据与端口分配（对齐 Nginx /ws 反代）

- **端口分配**：单机版为每个用户在宿主机分配一个固定 `hostPort`（从 `hostPortBase` 起，向后扫描 `hostPortScanSize` 个端口）。
- **workspace-meta.json**：首次 ensure 时会在宿主机写入：
  - 路径：`{hostRoot}/{userId}/workspace-meta.json`
  - 内容包含：`containerName / image / hostPort / containerPort / createdAt` 等
- **Nginx 端口查询（关键）**：
  - Nginx `/ws/{userId}/...` 会通过 `auth_request` 调用内部接口查询端口：
    - `GET /api/fun-ai/workspace/internal/nginx/port?userId=...`
    - Header：`X-WS-Token=<funai.workspace.nginxAuthToken>`
  - 内部接口仅返回头 `X-WS-Port`，并且**不会触发 ensure/start**（避免每次加载静态资源都产生副作用）
  - 依赖前置条件：用户必须至少执行过一次 `container/ensure`（生成 `workspace-meta.json`），否则端口查询会找不到。

### 8.3 主要接口（后端）

#### 8.3.1 容器级（不涉及具体 app 运行态）

- **确保容器运行**：`POST /api/fun-ai/workspace/container/ensure?userId=...`
  - 创建目录（`apps/`、`run/`）、初始化 `workspace-meta.json`、确保容器 `RUNNING`、挂载到 `containerWorkdir`（默认 `/workspace`）
- **查询容器状态**：`GET /api/fun-ai/workspace/container/status?userId=...`
- **心跳**：`POST /api/fun-ai/workspace/container/heartbeat?userId=...`
  - 更新活跃时间戳，配合 idle 回收

#### 8.3.2 运行态（Dev Server / 进程生命周期）

- **启动 dev（非阻塞）**：`POST /api/fun-ai/workspace/run/start?userId=...&appId=...`
  - 先写入 `/workspace/run/current.json(pid=null)`，再由后台脚本完成 `npm install` + `npm run dev`
  - dev server 参数包含：`--host 0.0.0.0 --port {containerPort} --strictPort --base /ws/{userId}/`
  - 备注：为了在容器+挂载卷场景下更可靠检测文件变更，启动脚本会启用 polling（`CHOKIDAR_USEPOLLING` 等）
- **查询运行态**：`GET /api/fun-ai/workspace/run/status?userId=...`
  - 状态：`IDLE / STARTING / RUNNING / DEAD / UNKNOWN`
  - `RUNNING` 时返回 `previewUrl = {previewBaseUrl}{previewPathPrefix}/{userId}/`
  - `STARTING` 可能表示仍在 `npm install`；若超过 `runStartingTimeoutSeconds` 仍未拿到 pid，会判定为 `DEAD`
- **停止运行**：`POST /api/fun-ai/workspace/run/stop?userId=...`
  - kill 进程组并清理 `/workspace/run/dev.pid` 与 `current.json`

#### 8.3.3 文件域（在线编辑器读写的宿主机持久化目录）

- **确保应用目录存在**：`POST /api/fun-ai/workspace/files/ensure-dir?userId=...&appId=...`
- **上传 zip 并解压**：`POST /api/fun-ai/workspace/files/upload-zip?userId=...&appId=...&overwrite=true`
- **获取文件树**：`GET /api/fun-ai/workspace/files/tree?userId=...&appId=...&path=.&maxDepth=6&maxEntries=5000`
- **读文件**：`GET /api/fun-ai/workspace/files/content?userId=...&appId=...&path=...`
- **写文件**：`POST /api/fun-ai/workspace/files/content`（JSON body，支持 `expectedLastModifiedMs` 乐观锁）
- **mkdir/delete/move**：`POST /api/fun-ai/workspace/files/mkdir|delete|move`
- **上传/下载单文件**：`POST /api/fun-ai/workspace/files/upload-file`、`GET /api/fun-ai/workspace/files/download-file`
- **下载应用目录 zip**：`GET /api/fun-ai/workspace/files/download-zip?includeNodeModules=false`

#### 8.3.4 实时通道（在线编辑器）

- **SSE（状态/日志）**：`GET /api/fun-ai/workspace/realtime/events?userId=...&appId=...&withLog=true`
  - 用于减少轮询；会增量推送 `dev.log` 与 run/status
- **WebSocket 终端**：`ws://{host}/api/fun-ai/workspace/ws/terminal?userId=...&appId=...`
  - Nginx 需透传 WebSocket（文档第 7 章已包含 `/api/fun-ai/workspace/ws/` 反代示例）

### 8.4 idle 回收（省钱模式）

定时任务：每 60 秒扫描活跃表（内存），按阈值触发回收：

- `idleStopRunMinutes`：超过则 stop run（清理 pid/meta/log）
- `idleStopContainerMinutes`：超过则 stop container（并且会先 stop run 避免残留）

> 约定：配置 `<=0` 表示禁用（避免误配 0 导致“立刻回收”，表现为容器总是 EXITED / 预览总是 502）。

---

## 9. 常见排错命令（强烈建议收藏）

### 9.1 后端服务

```bash
systemctl status fun-ai-studio --no-pager -l
journalctl -u fun-ai-studio -n 200 --no-pager
ps -ef | grep java | grep -v grep
```

### 9.2 Nginx

```bash
nginx -t
nginx -T 2>/dev/null | head -n 200
tail -n 200 /var/log/nginx/error.log
tail -n 200 /var/log/nginx/access.log
```

### 9.3 容器与端口

```bash
docker ps -a | head
docker ps -a --filter "name=ws-u-10000021" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
curl -I http://127.0.0.1:20021/
ss -lntp | grep 20021 || netstat -lntp | grep 20021
```

### 9.4 workspace 运行日志

宿主机：

```bash
ls -al /data/funai/workspaces/10000021/run/
tail -n 200 /data/funai/workspaces/10000021/run/dev.log
cat /data/funai/workspaces/10000021/run/current.json
```

容器内：

```bash
docker exec ws-u-10000021 bash -lc 'ls -al /workspace/run; tail -n 200 /workspace/run/dev.log'
```

---

## 10. 扩容注意事项（单机 → 多机的关键点）

当前实现是单机版（本机内存记录活跃、hostPort 绑定本机端口、Nginx 反代到本机 127.0.0.1）。

当你要扩到多机时，需要至少解决：

- **用户路由到哪台机器**（一致性哈希/网关/调度器）
- **workspace-meta.json 的一致性**（共享存储或中心化存储）
- **端口映射策略**（每台机器各自端口池）
- **idle tracker**（从本机内存升级为 Redis/DB）
- **安全**：Nginx token、内网访问策略、容器网络隔离

---


