server.port=8080
spring.application.name=funaistudioapi

spring.datasource.url=jdbc:mysql://localhost:3306/db_funaistudio?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true
spring.datasource.username=root
spring.datasource.password=Ss123456!
spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.MySQL8Dialect
spring.mvc.pathmatch.matching-strategy=ANT_PATH_MATCHER

# Swagger UI ??
# Spring Boot 3 + springdoc 2.x ????? /swagger-ui/index.html
springdoc.swagger-ui.path=/swagger-ui
springdoc.api-docs.path=/v3/api-docs
springdoc.swagger-ui.operationsSorter=method
# ?? Swagger UI
springdoc.swagger-ui.enabled=true
# ??????????
spring.web.resources.add-mappings=true
# ?? springdoc ????
springdoc.api-docs.enabled=true

# MyBatis-Plus ??
mybatis-plus.configuration.map-underscore-to-camel-case=true
mybatis-plus.global-config.db-config.id-type=auto

jwt.secret=funaistudio
#10?? ??24*7 168??36000*16.8
jwt.expiration=604800
# FunAI 对外站点基址（用于拼接外链/访问地址）
# 建议填写公网入口 IP 或域名
funai.siteBaseUrl=https://studio.fun.tv/
#?????
funai.siteLinkEnabled=true
funai.siteLinkRoot=/data/funai/sites

# -----------------------------
# Workspace（双机模式：API 服务器裁剪）
# - API 服务器（小机）保留 controller 用于 Swagger 展示
# - /api/fun-ai/workspace/** 的实际执行由 workspace-node 负责（API 服务器（小机）仅转发/签名）
# -----------------------------
funai.workspace.enabled=false
# -----------------------------
# API 服务器（小机）-> Workspace 开发服务器（大机）workspace-node 应用层代理（双机模式）
# - API 服务器（小机）对外仍暴露 /api/fun-ai/workspace/**（Swagger 可见）
# - 实际由 API 服务器（小机）转发到 Workspace 开发服务器（大机）workspace-node，并附带 X-WS-* 签名头
# -----------------------------
workspace-node-proxy.enabled=true
workspace-node-proxy.base-url=http://172.21.138.87:7001
# 与 Workspace 开发服务器（大机）workspace-node.internal.shared-secret 保持一致
workspace-node-proxy.shared-secret=ac462cfa76135504d2b750d541064ed5f03eb9f78f9068645995c4f825455f52
workspace-node-proxy.connect-timeout-ms=2000
# 0 表示不设置（SSE/下载更友好）
workspace-node-proxy.read-timeout-ms=0
# run/status 专用超时：避免删除后 cleanup/restart 阶段导致 list/info 卡住
workspace-node-proxy.run-status-timeout-ms=1200
# 计算签名需要 body sha256：超过阈值会落盘临时文件避免 OOM
workspace-node-proxy.body-spool-threshold-bytes=2097152

# -----------------------------
# Deploy 控制面（API -> deploy 服务）
# -----------------------------
deploy-proxy.enabled=true
# 建议填写 deploy 服务器内网地址
deploy-proxy.base-url=http://172.21.138.100:7002
# 预留：内部调用共享密钥（后续 deploy 服务加 InternalAuth 时启用）
deploy-proxy.shared-secret=a7c4e1d9f0b3c6a2e8d5f1c7b9a0d3e6f2a8c5d1e7b0a4c9d2f6a1e3b8c0d5f9
# 读取超时（毫秒）：避免 /deploy/apps/cleanup 卡住导致 API 线程长期阻塞
deploy-proxy.read-timeout-ms=8000
# listJobs 专用超时：用于 app/list 聚合展示，避免 Deploy 卡住拖慢 list
deploy-proxy.list-jobs-timeout-ms=1500

# -----------------------------
# App 删除接口（/api/fun-ai/app/delete）体验参数
# -----------------------------
# 删除接口最多等待外部清理（workspace/gitea/deploy）多久来收集“快速失败/快速成功”的结果；超时则秒回并后台继续清理
# 推荐：800ms（对用户“体感快”，同时还能拿到部分失败提示）
funai.app.delete.cleanup-wait-ms=800

# -----------------------------
# App 限制（可配置）
# -----------------------------
# 单用户最多可创建应用数量（默认 10）
funai.app.limits.max-apps-per-user=10

# -----------------------------
# Deploy Git（方案 C：自建 Git / Gitea）
# - API 在创建 deploy job 时自动补齐 repoSshUrl/gitRef（前端无需拼接）
# -----------------------------
deploy-git.enabled=true
deploy-git.ssh-host=172.21.138.103
deploy-git.ssh-port=2222
deploy-git.repo-owner=funai
deploy-git.repo-name-template=u{userId}-app{appId}
deploy-git.default-ref=main

# -----------------------------
# Deploy ACR（镜像仓库）
# - API 在创建 deploy job 时自动补齐 acrRegistry/acrNamespace（前端无需关心，Runner 优先使用 payload）

# 你们现网（参考 doc/domains/deploy/acr-auth-and-retention.md）
deploy-acr.enabled=true
# 你现网实际使用的 ACR Login Server（公网 endpoint）
#deploy-acr.registry=crpi-39dn3ekytub82xl9.cn-hangzhou.personal.cr.aliyuncs.com
deploy-acr.registry=172.21.138.103
# e.g. funaistudio
deploy-acr.namespace=funaistudio

# -----------------------------
# Gitea 自动化（创建 app 时自动建仓库 + 授权 runner-bot/team）
# - 注意：不要把 token 明文提交到代码仓库；生产建议通过 /opt/.../application-prod.properties 或环境变量注入
# - Authorization: token <gitea.admin-token>
# -----------------------------
gitea.enabled=true
gitea.base-url=http://172.21.138.103:3000
gitea.admin-token=264ebe1d16fce5337ea1b1f5298a4c468095acb3
gitea.owner=funai
gitea.repo-name-template=u{userId}-app{appId}
gitea.auto-init=true
gitea.default-branch=main
# 优先：组织 team（Read）
gitea.runner-team=runner-readonly
# 兜底：runner-bot 用户名（Read）
gitea.runner-bot=runner-bot
# 优先：组织 team（Write）
gitea.workspace-team=workspace-write
# Workspace 写入 bot（Write，用于前端一键 commit/push）
gitea.workspace-bot=workspace-bot
#build.buildedPath=D:\\dev\\h5\\code\\talos\\dist\\
spring.ai.dashscope.api-key=sk-8e78660ba8034d528093e4fd7839f7df
#?????????
spring.ai.alibaba.bialian.enable=true
spring.ai.alibaba.bialian.index-name="saa-playground-2"

# ????
logging.level.root=INFO
# -----------------------------
# 日志落盘（API 服务）
# -----------------------------
logging.file.name=/data/funai/logs/fun-ai-studio-api/app.log

# 按天滚动 + 按大小分片（必须包含 %i；gzip 压缩）
logging.logback.rollingpolicy.file-name-pattern=/data/funai/logs/fun-ai-studio-api/app.%d{yyyy-MM-dd}.%i.log.gz
# 单文件最大大小（超过会在同一天内滚动到下一个 %i）
logging.logback.rollingpolicy.max-file-size=100MB

# 保留最近 30 天
logging.logback.rollingpolicy.max-history=30

# 总日志大小上限（超过会清理旧日志）
logging.logback.rollingpolicy.total-size-cap=5GB

# 启动时清理超期日志
logging.logback.rollingpolicy.clean-history-on-start=true

# -----------------------------
# 上传大小限制（避免 upload-zip 几 MB 就触发默认 1MB 限制）
# - 注意：Nginx 也需要 client_max_body_size 配合（我们已在 nginx 示例里设置为 200m）
# -----------------------------
spring.servlet.multipart.enabled=true
spring.servlet.multipart.max-file-size=200MB
spring.servlet.multipart.max-request-size=200MB
# Tomcat：避免大请求被吞掉导致连接异常（与上面保持一致/更大）
server.tomcat.max-swallow-size=200MB

# -----------------------------
# Admin 管理接口（不依赖 JWT）：IP 白名单 + Header Token
# - 仅用于 /api/fun-ai/admin/**
# - 静态页面可放行，但 API 必须鉴权
# -----------------------------
funai.admin.enabled=true
funai.admin.allowed-ips=172.17.5.80,127.0.0.1
funai.admin.token=4f3d8a72e19d7c0b6c2a7e4e8c3f1b2d9a4c0f6b1d8e7a2c3b9f0a6d5c1e7b8a3d2f9c0e1b7a6c4d8e2f0a9b1c3d5e7f8a0b2c4d6e8f0a1b3c5d7e9f1a3b5c7d9e1f3a5b7c9d1e3f5a7b9c1d3e5f7a9b1c3d5e7f9

# -----------------------------
# workspace-node 节点注册/心跳（API 服务侧）
# -----------------------------
funai.workspace-node-registry.enabled=true
# 与 workspace-node 侧上报 Header：X-WS-Node-Token 一致（生产请替换为强随机值）
funai.workspace-node-registry.shared-secret=4f2b1a9c8d3e7a60b1c9d7e5f3a8b6c4d2e0f9a7c5b3d1e8f6a4c2e9b7d5f0a1c3e8b2d6f9a0c4e7b1d5f8a2c6e9b3d7f0a4c8e1b5d9f2a6c0e3b7d1f4a8c2e5b9d0f3a7c1e4b8d2f5a9c3e6b0d4f7a1c5e8b2d6f9a0c4e7b1d5f8a2c6e9b3d7f0a4c8e1b5d9f2a6c0e3b7d1f4a8c2
# 建议配置为 workspace-node 节点的内网 IP（逗号分隔）；为空则不校验
funai.workspace-node-registry.allowed-ips=172.21.138.87
# 心跳超时阈值（秒）
funai.workspace-node-registry.heartbeat-stale-seconds=60

# -----------------------------
# workspace-node 故障转移（API 服务侧）
# -----------------------------
workspace-node.failover.auto-reassign.enabled=false
workspace-node.failover.auto-reassign.max-idle-minutes=30

# -----------------------------
# AI 对话上下文管理配置
# -----------------------------
# 每个应用允许的最大活跃会话数
funai.conversation.max-conversations-per-app=5
# 每个会话允许的最大消息数
funai.conversation.max-messages-per-conversation=30
